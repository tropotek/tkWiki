(function(){tinymce.create("tinymce.plugins.PreElementFix",{init:function(A,B){var C=this;if(tinymce.isIE||tinymce.isWebKit){A.onKeyDown.add(function(D,G){var H,F=D.selection;if(G.keyCode==13&&F.getNode().nodeName=="PRE"){var E='<br id="__preElementFix" /> ';F.setContent(E,{format:"raw"});H=D.dom.get("__preElementFix");H.removeAttribute("id");F.select(H);F.collapse();return tinymce.dom.Event.cancel(G)}})}if(tinymce.isGecko){A.onKeyDown.add(function(D,F){var G,E=D.selection;if(F.keyCode==9&&E.getNode().nodeName=="PRE"){E.setContent("\t",{format:"raw"});return tinymce.dom.Event.cancel(F)}})}A.onBeforeGetContent.add(function(D,E){C._replaceBrElementsWithNewlines(D);C._removeSpanElementsInPreElementsForWebKit(D)});A.onGetContent.add(function(D,E){C._removeLastNewlineFromPrelements(D,E)})},getInfo:function(){return{longname:"Pre Element Fix",author:"tan@enonic.com",authorurl:"http://www.enonic.com",infourl:"http://www.enonic.com",version:"0.1"}},_replaceBrElementsWithNewlines:function(D){var B=D.dom.select("pre br");for(var E=0;E<B.length;E++){var C;if(tinymce.isIE){C="\r"}else{C="\n"}var A=D.getDoc().createTextNode(C);D.dom.insertAfter(A,B[E]);D.dom.remove(B[E])}},_removeSpanElementsInPreElementsForWebKit:function(B){if(tinymce.isWebKit){var A=B.dom.select("pre span");for(var C=0;C<A.length;C++){var D=B.getDoc().createTextNode(A[C].innerHTML);B.dom.insertAfter(D,A[C]);B.dom.remove(A[C])}}},_removeLastNewlineFromPrelements:function(A,B){B.content=B.content.replace(/\n*<\/pre>$/g,"</pre>").replace(/\s*<\/pre>$/g,"</pre>")}});tinymce.PluginManager.add("preelementfix",tinymce.plugins.PreElementFix)})();